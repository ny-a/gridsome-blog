<!DOCTYPE html>
<html data-html-server-rendered="true" lang="en" data-vue-tag="%7B%22lang%22:%7B%22ssr%22:%22en%22%7D%7D">
  <head>
    <title>Gridsome - Gridsome</title><meta name="gridsome:hash" content="1d9f99e93ff3ea930f8b2906773a2a2d2c0d7a1c"><meta data-vue-tag="ssr" charset="utf-8"><meta data-vue-tag="ssr" name="generator" content="Gridsome v0.7.14"><meta data-vue-tag="ssr" data-key="viewport" name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"><meta data-vue-tag="ssr" data-key="format-detection" name="format-detection" content="telephone=no"><link data-vue-tag="ssr" rel="icon" href="data:,"><link data-vue-tag="ssr" rel="icon" type="image/png" sizes="16x16" href="/gridsome-blog/assets/static/favicon.ce0531f.9bb7ffafafc09ac851d81afb65b8ef59.png"><link data-vue-tag="ssr" rel="icon" type="image/png" sizes="32x32" href="/gridsome-blog/assets/static/favicon.ac8d93a.9bb7ffafafc09ac851d81afb65b8ef59.png"><link data-vue-tag="ssr" rel="icon" type="image/png" sizes="96x96" href="/gridsome-blog/assets/static/favicon.b9532cc.9bb7ffafafc09ac851d81afb65b8ef59.png"><link data-vue-tag="ssr" rel="apple-touch-icon" type="image/png" sizes="76x76" href="/gridsome-blog/assets/static/favicon.f22e9f3.9bb7ffafafc09ac851d81afb65b8ef59.png"><link data-vue-tag="ssr" rel="apple-touch-icon" type="image/png" sizes="152x152" href="/gridsome-blog/assets/static/favicon.62d22cb.9bb7ffafafc09ac851d81afb65b8ef59.png"><link data-vue-tag="ssr" rel="apple-touch-icon" type="image/png" sizes="120x120" href="/gridsome-blog/assets/static/favicon.1539b60.9bb7ffafafc09ac851d81afb65b8ef59.png"><link data-vue-tag="ssr" rel="apple-touch-icon" type="image/png" sizes="167x167" href="/gridsome-blog/assets/static/favicon.dc0cdc5.9bb7ffafafc09ac851d81afb65b8ef59.png"><link data-vue-tag="ssr" rel="apple-touch-icon" type="image/png" sizes="180x180" href="/gridsome-blog/assets/static/favicon.7b22250.9bb7ffafafc09ac851d81afb65b8ef59.png"><link rel="preload" href="/gridsome-blog/assets/css/0.styles.dd5de3ed.css" as="style"><link rel="preload" href="/gridsome-blog/assets/js/app.ddfdb408.js" as="script"><link rel="preload" href="/gridsome-blog/assets/js/page--src--templates--post-vue.c275e0ae.js" as="script"><link rel="prefetch" href="/gridsome-blog/assets/js/page--node-modules--gridsome--app--pages--404-vue.b08f0808.js"><link rel="prefetch" href="/gridsome-blog/assets/js/page--src--pages--index-vue.df9f8b29.js"><link rel="stylesheet" href="/gridsome-blog/assets/css/0.styles.dd5de3ed.css"><noscript data-vue-tag="ssr"><style>.g-image--loading{display:none;}</style></noscript>
  </head>
  <body >
    <div data-server-rendered="true" id="app" class="layout"><header class="header"><strong><a href="/gridsome-blog/" class="active">Gridsome</a></strong><nav class="nav"><a href="/gridsome-blog/" class="nav__link active">Home</a></nav></header><div class="post-title"><h1>SpotFleet内の複数インスタンスで連番を生成するスクリプト</h1><p class="post-date"> 01 March 2020 | 1 min read</p></div><div class="post-content"><p><p>AWS でスポットインスタンスを複数起動して大量の処理を行うことがたまにあります。
Terraform で SpotFleet をリクエストして複数のインスタンスを立ち上げることはできますが、個別に user_data を指定するのは
少し面倒です。</p>
<p>ただ、同じ user_data でも、重複しない連番さえ取ることができればなんとかなることも多いはず……と思っていて、
パラメータストアを使ったり DynamoDB の AtomicCounter を使ったりしているようですが、
AWS CLI + jq だけで生成する方法を考えてみました。</p>
<h2 id="スクリプト"><a href="#%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%97%E3%83%88" aria-hidden="true"><span class="icon icon-link"></span></a>スクリプト</h2>
<pre class="language-shell"><code class="language-shell"><span class="token shebang important">#!/bin/bash</span>

<span class="token assign-left variable">TOKEN</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">curl</span> -s -XPUT <span class="token string">"http://169.254.169.254/latest/api/token"</span> -H <span class="token string">"X-aws-ec2-metadata-token-ttl-seconds: 21600"</span><span class="token variable">)</span></span>
<span class="token assign-left variable">INSTANCE_ID</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">curl</span> -sH <span class="token string">"X-aws-ec2-metadata-token: <span class="token variable">$TOKEN</span>"</span> http://169.254.169.254/latest/meta-data/instance-id<span class="token variable">)</span></span>
<span class="token assign-left variable">FLEET_ID</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>aws ec2 describe-instances --instance-ids $INSTANCE_ID <span class="token operator">|</span> jq -r <span class="token string">'.Reservations[].Instances[].Tags[] | select(.Key == "aws:ec2spot:fleet-request-id").Value'</span><span class="token variable">)</span></span>
<span class="token assign-left variable">TARGET_CAPACITY</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>aws ec2 describe-spot-fleet-requests --spot-fleet-request-ids $FLEET_ID <span class="token operator">|</span> jq <span class="token string">'.SpotFleetRequestConfigs[].SpotFleetRequestConfig.TargetCapacity'</span><span class="token variable">)</span></span>

<span class="token keyword">while</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token keyword">do</span>
  aws ec2 describe-instances --filter <span class="token assign-left variable">Name</span><span class="token operator">=</span>tag:aws:ec2spot:fleet-request-id,Values<span class="token operator">=</span><span class="token variable">$FLEET_ID</span> <span class="token operator">|</span> jq -r <span class="token string">'.Reservations[].Instances[].InstanceId'</span> <span class="token operator">|</span> <span class="token function">sort</span> <span class="token operator">></span> /tmp/instance_ids.txt
  <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token variable"><span class="token variable">$(</span><span class="token function">cat</span> /tmp/instance_ids.txt <span class="token operator">|</span> <span class="token function">wc</span> -l<span class="token variable">)</span></span> -eq <span class="token variable">$TARGET_CAPACITY</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
    <span class="token builtin class-name">break</span>
  <span class="token keyword">fi</span>
  <span class="token function">sleep</span> <span class="token number">10</span>
<span class="token keyword">done</span>

<span class="token function">cat</span> /tmp/instance_ids.txt<span class="token operator">|</span><span class="token function">awk</span> <span class="token string">"/<span class="token variable">$INSTANCE_ID</span>/{print FNR - 1}"</span>
<span class="token function">rm</span> /tmp/instance_ids.txt</code></pre>
<p>SpotFleet で起動したインスタンスには、 FleetRequestId のタグが付けられています(というか taggingRole がありますよね)。
Tag がついているということはインスタンスをフィルタリングできるので、 FleetRequest 内のインスタンスIDを列挙してソートし、
自分のインスタンスIDの位置を awk で導出しています。(今回は 0-origin にしました。)</p>
<p>これの弱点？として、インスタンスが全て立ち上がっているときを想定しているため、起動していないインスタンスは待ちますが、
既に終了したインスタンスがあって CLI で取得できなくなった場合は永遠に待ち続けてしまいます。
時間が経ってから呼ぶ可能性があるなら <code>/tmp/instance_ids</code> を消さないようにするか、
起動時に自動実行しておいて番号自体をキャッシュすればある程度回避できそうです。</p>
<p>Ansible とか使えばいいのでは？という気持ちも少しずつ出てきています。
というか、こういった分離しやすいワークロードを分散して実行するようなツール、ありそうなんですよね……。
Docker 化してオーケストレーションが早そうではあります。 </p>
</p></div><div class="footer"><p>
      Built with
      <a href="//gridsome.org" class="link">Gridsome</a></p></div></div>
    <script>window.__INITIAL_STATE__={"data":{"post":{"id":"61c51582d03d5761240f212309e1a88a","title":"SpotFleet内の複数インスタンスで連番を生成するスクリプト","content":"\u003Cp\u003EAWS でスポットインスタンスを複数起動して大量の処理を行うことがたまにあります。\nTerraform で SpotFleet をリクエストして複数のインスタンスを立ち上げることはできますが、個別に user_data を指定するのは\n少し面倒です。\u003C\u002Fp\u003E\n\u003Cp\u003Eただ、同じ user_data でも、重複しない連番さえ取ることができればなんとかなることも多いはず……と思っていて、\nパラメータストアを使ったり DynamoDB の AtomicCounter を使ったりしているようですが、\nAWS CLI + jq だけで生成する方法を考えてみました。\u003C\u002Fp\u003E\n\u003Ch2 id=\"スクリプト\"\u003E\u003Ca href=\"#%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%97%E3%83%88\" aria-hidden=\"true\"\u003E\u003Cspan class=\"icon icon-link\"\u003E\u003C\u002Fspan\u003E\u003C\u002Fa\u003Eスクリプト\u003C\u002Fh2\u003E\n\u003Cpre class=\"language-shell\"\u003E\u003Ccode class=\"language-shell\"\u003E\u003Cspan class=\"token shebang important\"\u003E#!\u002Fbin\u002Fbash\u003C\u002Fspan\u003E\n\n\u003Cspan class=\"token assign-left variable\"\u003ETOKEN\u003C\u002Fspan\u003E\u003Cspan class=\"token operator\"\u003E=\u003C\u002Fspan\u003E\u003Cspan class=\"token variable\"\u003E\u003Cspan class=\"token variable\"\u003E$(\u003C\u002Fspan\u003E\u003Cspan class=\"token function\"\u003Ecurl\u003C\u002Fspan\u003E -s -XPUT \u003Cspan class=\"token string\"\u003E\"http:\u002F\u002F169.254.169.254\u002Flatest\u002Fapi\u002Ftoken\"\u003C\u002Fspan\u003E -H \u003Cspan class=\"token string\"\u003E\"X-aws-ec2-metadata-token-ttl-seconds: 21600\"\u003C\u002Fspan\u003E\u003Cspan class=\"token variable\"\u003E)\u003C\u002Fspan\u003E\u003C\u002Fspan\u003E\n\u003Cspan class=\"token assign-left variable\"\u003EINSTANCE_ID\u003C\u002Fspan\u003E\u003Cspan class=\"token operator\"\u003E=\u003C\u002Fspan\u003E\u003Cspan class=\"token variable\"\u003E\u003Cspan class=\"token variable\"\u003E$(\u003C\u002Fspan\u003E\u003Cspan class=\"token function\"\u003Ecurl\u003C\u002Fspan\u003E -sH \u003Cspan class=\"token string\"\u003E\"X-aws-ec2-metadata-token: \u003Cspan class=\"token variable\"\u003E$TOKEN\u003C\u002Fspan\u003E\"\u003C\u002Fspan\u003E http:\u002F\u002F169.254.169.254\u002Flatest\u002Fmeta-data\u002Finstance-id\u003Cspan class=\"token variable\"\u003E)\u003C\u002Fspan\u003E\u003C\u002Fspan\u003E\n\u003Cspan class=\"token assign-left variable\"\u003EFLEET_ID\u003C\u002Fspan\u003E\u003Cspan class=\"token operator\"\u003E=\u003C\u002Fspan\u003E\u003Cspan class=\"token variable\"\u003E\u003Cspan class=\"token variable\"\u003E$(\u003C\u002Fspan\u003Eaws ec2 describe-instances --instance-ids $INSTANCE_ID \u003Cspan class=\"token operator\"\u003E|\u003C\u002Fspan\u003E jq -r \u003Cspan class=\"token string\"\u003E'.Reservations[].Instances[].Tags[] | select(.Key == \"aws:ec2spot:fleet-request-id\").Value'\u003C\u002Fspan\u003E\u003Cspan class=\"token variable\"\u003E)\u003C\u002Fspan\u003E\u003C\u002Fspan\u003E\n\u003Cspan class=\"token assign-left variable\"\u003ETARGET_CAPACITY\u003C\u002Fspan\u003E\u003Cspan class=\"token operator\"\u003E=\u003C\u002Fspan\u003E\u003Cspan class=\"token variable\"\u003E\u003Cspan class=\"token variable\"\u003E$(\u003C\u002Fspan\u003Eaws ec2 describe-spot-fleet-requests --spot-fleet-request-ids $FLEET_ID \u003Cspan class=\"token operator\"\u003E|\u003C\u002Fspan\u003E jq \u003Cspan class=\"token string\"\u003E'.SpotFleetRequestConfigs[].SpotFleetRequestConfig.TargetCapacity'\u003C\u002Fspan\u003E\u003Cspan class=\"token variable\"\u003E)\u003C\u002Fspan\u003E\u003C\u002Fspan\u003E\n\n\u003Cspan class=\"token keyword\"\u003Ewhile\u003C\u002Fspan\u003E \u003Cspan class=\"token boolean\"\u003Etrue\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E;\u003C\u002Fspan\u003E \u003Cspan class=\"token keyword\"\u003Edo\u003C\u002Fspan\u003E\n  aws ec2 describe-instances --filter \u003Cspan class=\"token assign-left variable\"\u003EName\u003C\u002Fspan\u003E\u003Cspan class=\"token operator\"\u003E=\u003C\u002Fspan\u003Etag:aws:ec2spot:fleet-request-id,Values\u003Cspan class=\"token operator\"\u003E=\u003C\u002Fspan\u003E\u003Cspan class=\"token variable\"\u003E$FLEET_ID\u003C\u002Fspan\u003E \u003Cspan class=\"token operator\"\u003E|\u003C\u002Fspan\u003E jq -r \u003Cspan class=\"token string\"\u003E'.Reservations[].Instances[].InstanceId'\u003C\u002Fspan\u003E \u003Cspan class=\"token operator\"\u003E|\u003C\u002Fspan\u003E \u003Cspan class=\"token function\"\u003Esort\u003C\u002Fspan\u003E \u003Cspan class=\"token operator\"\u003E\u003E\u003C\u002Fspan\u003E \u002Ftmp\u002Finstance_ids.txt\n  \u003Cspan class=\"token keyword\"\u003Eif\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E[\u003C\u002Fspan\u003E \u003Cspan class=\"token variable\"\u003E\u003Cspan class=\"token variable\"\u003E$(\u003C\u002Fspan\u003E\u003Cspan class=\"token function\"\u003Ecat\u003C\u002Fspan\u003E \u002Ftmp\u002Finstance_ids.txt \u003Cspan class=\"token operator\"\u003E|\u003C\u002Fspan\u003E \u003Cspan class=\"token function\"\u003Ewc\u003C\u002Fspan\u003E -l\u003Cspan class=\"token variable\"\u003E)\u003C\u002Fspan\u003E\u003C\u002Fspan\u003E -eq \u003Cspan class=\"token variable\"\u003E$TARGET_CAPACITY\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E]\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E;\u003C\u002Fspan\u003E \u003Cspan class=\"token keyword\"\u003Ethen\u003C\u002Fspan\u003E\n    \u003Cspan class=\"token builtin class-name\"\u003Ebreak\u003C\u002Fspan\u003E\n  \u003Cspan class=\"token keyword\"\u003Efi\u003C\u002Fspan\u003E\n  \u003Cspan class=\"token function\"\u003Esleep\u003C\u002Fspan\u003E \u003Cspan class=\"token number\"\u003E10\u003C\u002Fspan\u003E\n\u003Cspan class=\"token keyword\"\u003Edone\u003C\u002Fspan\u003E\n\n\u003Cspan class=\"token function\"\u003Ecat\u003C\u002Fspan\u003E \u002Ftmp\u002Finstance_ids.txt\u003Cspan class=\"token operator\"\u003E|\u003C\u002Fspan\u003E\u003Cspan class=\"token function\"\u003Eawk\u003C\u002Fspan\u003E \u003Cspan class=\"token string\"\u003E\"\u002F\u003Cspan class=\"token variable\"\u003E$INSTANCE_ID\u003C\u002Fspan\u003E\u002F{print FNR - 1}\"\u003C\u002Fspan\u003E\n\u003Cspan class=\"token function\"\u003Erm\u003C\u002Fspan\u003E \u002Ftmp\u002Finstance_ids.txt\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003ESpotFleet で起動したインスタンスには、 FleetRequestId のタグが付けられています(というか taggingRole がありますよね)。\nTag がついているということはインスタンスをフィルタリングできるので、 FleetRequest 内のインスタンスIDを列挙してソートし、\n自分のインスタンスIDの位置を awk で導出しています。(今回は 0-origin にしました。)\u003C\u002Fp\u003E\n\u003Cp\u003Eこれの弱点？として、インスタンスが全て立ち上がっているときを想定しているため、起動していないインスタンスは待ちますが、\n既に終了したインスタンスがあって CLI で取得できなくなった場合は永遠に待ち続けてしまいます。\n時間が経ってから呼ぶ可能性があるなら \u003Ccode\u003E\u002Ftmp\u002Finstance_ids\u003C\u002Fcode\u003E を消さないようにするか、\n起動時に自動実行しておいて番号自体をキャッシュすればある程度回避できそうです。\u003C\u002Fp\u003E\n\u003Cp\u003EAnsible とか使えばいいのでは？という気持ちも少しずつ出てきています。\nというか、こういった分離しやすいワークロードを分散して実行するようなツール、ありそうなんですよね……。\nDocker 化してオーケストレーションが早そうではあります。 \u003C\u002Fp\u003E\n","date":"01 March 2020","timeToRead":1}},"context":{}};(function(){var s;(s=document.currentScript||document.scripts[document.scripts.length-1]).parentNode.removeChild(s);}());</script><script src="/gridsome-blog/assets/js/app.ddfdb408.js" defer></script><script src="/gridsome-blog/assets/js/page--src--templates--post-vue.c275e0ae.js" defer></script>
  </body>
</html>
