{"hash":"81cb1430c363b923714946935c0565f4a2e1da5b","data":{"post":{"id":"32a55648bd9d1baffb4f434cb8da5538","title":"sudoに-iオプションをつけるとクオートの挙動が変わってハマりました","content":"<p><code>sudo</code> コマンドには <code>-i/--login</code> オプションがあり、コマンドを走らせるユーザー(デフォルトは root)のログインシェルを\n使ってコマンドを実行できますが、このオプションを指定する場合としない場合でクオートの扱いが変わってハマってしまいました。</p>\n<p>具体的には、EC2 の root で実行される user_data スクリプトで、 パスフレーズなしのキーペアを生成する際に</p>\n<pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token function\">sudo</span> -u ec2-user -i ssh-keygen -f .ssh/id_rsa -N <span class=\"token string\">''</span></code></pre>\n<p>とすると、 <code>option requires an argument -- N</code> というエラーが発生してしまいます。</p>\n<p>(ちなみにここで生成したキーペアは、 git clone をするための deploy key として使おうとしています。\nuser_data とはいえ private key を含めたくなかったので、インスタンスで生成して public key を登録する形にしました。\n結局 API を叩くときなどに使用する token/secret は user_data に含めることになるんですが……)</p>\n<h2 id=\"issues\"><a href=\"#issues\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>issues</h2>\n<p>この問題ズバリの issue が5年前に出ていますが、1つもコメントはついていません。\n<a href=\"https://bugzilla.sudo.ws/show_bug.cgi?id=679\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Bug 679 - sudo -i ignores empty arguments</a></p>\n<p>10 年前の\n<a href=\"https://bugzilla.sudo.ws/show_bug.cgi?id=413\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Bug 413 - Unexpected change in quoting behaviour with -i flag</a>\nも同じ問題を指しているように読めますが、こちらも1ヶ月経たずに放置されてしまっています。</p>\n<h2 id=\"workaround\"><a href=\"#workaround\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>workaround</h2>\n<p>とりあえずの解決策としては、\n<a href=\"https://bugzilla.sudo.ws/show_bug.cgi?id=679\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">#679</a>\nにある stackoverflow へのリンク\n<a href=\"https://stackoverflow.com/questions/27892812/passing-empty-arguments-to-sudo-i\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Passing empty arguments to sudo -i</a>\nにある通り、 <code>sudo -i sh -c 'foo \"bar\" \"\"'</code> などとすればうまく動くようです。</p>\n<p>ただ、あまり嬉しい見た目ではないので、私は <code>-i</code> オプションを使わないで、\n<code>sudo -u ec2-user ssh-keygen -f /home/ec2-user/.ssh/id_rsa -N ''</code>\nとすることにしました。</p>\n<p><code>sudo</code> がデファクトスタンダードのようなものと認識していて、何の疑問もなく使っていたのですが、\n脆弱性の問題なども見かけるので <code>doas</code> なども使ってみようかなと思いました。</p>\n","date":"29 February 2020","timeToRead":1}},"context":{}}