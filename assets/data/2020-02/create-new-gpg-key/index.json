{"hash":"df390429539c3d849410137755fe2019a559a748","data":{"post":{"id":"e2e3946133d833ff279df664dae4e4d9","title":"新しいGPGキーを作成しました","content":"<p>Yubikey もあることですし、そろそろ GPG や SSH の秘密鍵を統一しようと思います。\n<a href=\"http://joemphilips.com/post/gpg_memo/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">GPGで自分用の秘密鍵を1つに統一する</a>\nを参考に進めていきました。</p>\n<p>上記記事ではエアギャップコンピュータが推奨されていますが、今回はマスターキーのバックアップの\n利便性のため、ネットワークに接続した状態で行いました。\n<a href=\"https://www.qubes-os.org/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">QUBES OS</a> はよさそうですね。 Fedora ベースなのが\n少し気になるといえばそうですが……(ArchLinux に慣れているため)。</p>\n<p>さて、普段使いの環境にはマスターキーの秘密鍵は置いておきたくないので、\nマスターキーの生成は別の環境で行います。\nバックアップの利便性なども考えて、 LUKS で暗号化したパーティションをファイルに保存します。</p>\n<pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token function\">dd</span> <span class=\"token assign-left variable\">if</span><span class=\"token operator\">=</span>/dev/zero <span class=\"token assign-left variable\">of</span><span class=\"token operator\">=</span>encrypted_partition.img <span class=\"token assign-left variable\">bs</span><span class=\"token operator\">=</span>1M <span class=\"token assign-left variable\">count</span><span class=\"token operator\">=</span><span class=\"token number\">64</span>\n<span class=\"token function\">sudo</span> cryptsetup luksFormat -i <span class=\"token number\">5000</span> --use-random encrypted_partition.img\n<span class=\"token comment\"># type 'YES' and set password</span>\n<span class=\"token function\">sudo</span> cryptsetup luksOpen encrypted_partition.img gpg_container\n<span class=\"token function\">sudo</span> mkfs.ext4 /dev/mapper/gpg_container\n<span class=\"token function\">sudo</span> <span class=\"token function\">mount</span> /dev/mapper/gpg_container /mnt\n<span class=\"token function\">sudo</span> <span class=\"token function\">mkdir</span> /mnt/.gnupg\n<span class=\"token function\">sudo</span> <span class=\"token function\">chown</span> <span class=\"token punctuation\">[</span>current_user<span class=\"token punctuation\">]</span> /mnt/.gnupg</code></pre>\n<p>GPG の操作は今作成した <code>/mnt/.gnupg</code> を GNUPGHOME に設定して行います。\n必要なだけマスターキーとサブキーを作成していきます。</p>\n<pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token assign-left variable\">GNUPGHOME</span><span class=\"token operator\">=</span>/mnt/.gnupg gpg --full-gen-key</code></pre>\n<p>作成が終わったら、サブキーだけをエクスポートします。キーの fingerprint は <code>gpg -K</code> で確認できます。</p>\n<pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token assign-left variable\">GNUPGHOME</span><span class=\"token operator\">=</span>/mnt/.gnupg gpg --output <span class=\"token punctuation\">[</span>exported-file<span class=\"token punctuation\">]</span> --export-secret-subkeys <span class=\"token punctuation\">[</span>fingerprint<span class=\"token punctuation\">]</span></code></pre>\n<p>エクスポートしたファイルを scp などで普段使う環境にコピーしたら、インポートして信頼します。\n今自分で作成したキーなので、信頼度は 5 (I trust ultimately) でよいでしょう。</p>\n<pre class=\"language-shell\"><code class=\"language-shell\">gpg --import <span class=\"token punctuation\">[</span>exported-file<span class=\"token punctuation\">]</span>\ngpg --edit-key <span class=\"token punctuation\">[</span>fingerprint<span class=\"token punctuation\">]</span>\n    <span class=\"token operator\">></span> trust\n    <span class=\"token operator\">></span> <span class=\"token number\">5</span> <span class=\"token comment\"># I trust ultimately</span>\n    <span class=\"token operator\">></span> save</code></pre>\n<p>あとは、 <code>gpg -K --with-keygrip</code> で ssh に使いたいキーの keygrip を確認して、 <code>~/.gnupg/sshcontrol</code> に追加します。\n<code>~/.ssh/config</code> の <code>IdentityFile</code> でキーを指定する場合は、 <code>gpg -K --with-subkey-fingerprint</code> でサブキーの\nfingerprint を確認して、 <code>gpg --export-ssh-key [fingerprint] > ~/.ssh/id_something.pub</code> を実行します。\n<code>IdentityFile</code> には今作成した <code>id_something.pub</code> を指定してください。</p>\n<p>gpg-agent を ssh-agent として使う方法は\n<a href=\"/2020-01/introduction-of-gpg-ssh-agent/\">GnuPGのssh-agentエミュレータを使ってみました</a>\nに書いた通りです。</p>\n<p>addkey をする場合やサブキーの有効期限を変更する場合などはマスターキーが必要になりますが、\nそれまではマスターキーの秘密鍵がない状態でうまく機能するでしょう。\n将来的にはオフラインのマシン上で行いたいですが、ひとまず普段から GPG を使う習慣をつけて\n慣れておこうと思っています。</p>\n","date":"04 February 2020","timeToRead":1}},"context":{}}