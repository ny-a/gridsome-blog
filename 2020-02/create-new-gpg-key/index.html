<!DOCTYPE html>
<html data-html-server-rendered="true" lang="en" data-vue-tag="%7B%22lang%22:%7B%22ssr%22:%22en%22%7D%7D">
  <head>
    <title>Gridsome - Gridsome</title><meta name="gridsome:hash" content="d5e5903248c4b0d5af4b0fecfa4b40b1e78b5555"><meta data-vue-tag="ssr" charset="utf-8"><meta data-vue-tag="ssr" name="generator" content="Gridsome v0.7.14"><meta data-vue-tag="ssr" data-key="viewport" name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"><meta data-vue-tag="ssr" data-key="format-detection" name="format-detection" content="telephone=no"><link data-vue-tag="ssr" rel="icon" href="data:,"><link data-vue-tag="ssr" rel="icon" type="image/png" sizes="16x16" href="/gridsome-blog/assets/static/favicon.ce0531f.9bb7ffafafc09ac851d81afb65b8ef59.png"><link data-vue-tag="ssr" rel="icon" type="image/png" sizes="32x32" href="/gridsome-blog/assets/static/favicon.ac8d93a.9bb7ffafafc09ac851d81afb65b8ef59.png"><link data-vue-tag="ssr" rel="icon" type="image/png" sizes="96x96" href="/gridsome-blog/assets/static/favicon.b9532cc.9bb7ffafafc09ac851d81afb65b8ef59.png"><link data-vue-tag="ssr" rel="apple-touch-icon" type="image/png" sizes="76x76" href="/gridsome-blog/assets/static/favicon.f22e9f3.9bb7ffafafc09ac851d81afb65b8ef59.png"><link data-vue-tag="ssr" rel="apple-touch-icon" type="image/png" sizes="152x152" href="/gridsome-blog/assets/static/favicon.62d22cb.9bb7ffafafc09ac851d81afb65b8ef59.png"><link data-vue-tag="ssr" rel="apple-touch-icon" type="image/png" sizes="120x120" href="/gridsome-blog/assets/static/favicon.1539b60.9bb7ffafafc09ac851d81afb65b8ef59.png"><link data-vue-tag="ssr" rel="apple-touch-icon" type="image/png" sizes="167x167" href="/gridsome-blog/assets/static/favicon.dc0cdc5.9bb7ffafafc09ac851d81afb65b8ef59.png"><link data-vue-tag="ssr" rel="apple-touch-icon" type="image/png" sizes="180x180" href="/gridsome-blog/assets/static/favicon.7b22250.9bb7ffafafc09ac851d81afb65b8ef59.png"><link rel="preload" href="/gridsome-blog/assets/css/0.styles.dd5de3ed.css" as="style"><link rel="preload" href="/gridsome-blog/assets/js/app.95c605ed.js" as="script"><link rel="preload" href="/gridsome-blog/assets/js/page--src--templates--post-vue.c275e0ae.js" as="script"><link rel="prefetch" href="/gridsome-blog/assets/js/page--node-modules--gridsome--app--pages--404-vue.b08f0808.js"><link rel="prefetch" href="/gridsome-blog/assets/js/page--src--pages--index-vue.df9f8b29.js"><link rel="stylesheet" href="/gridsome-blog/assets/css/0.styles.dd5de3ed.css"><noscript data-vue-tag="ssr"><style>.g-image--loading{display:none;}</style></noscript>
  </head>
  <body >
    <div data-server-rendered="true" id="app" class="layout"><header class="header"><strong><a href="/gridsome-blog/" class="active">Gridsome</a></strong><nav class="nav"><a href="/gridsome-blog/" class="nav__link active">Home</a></nav></header><div class="post-title"><h1>新しいGPGキーを作成しました</h1><p class="post-date"> 04 February 2020 | 1 min read</p></div><div class="post-content"><p><p>Yubikey もあることですし、そろそろ GPG や SSH の秘密鍵を統一しようと思います。
<a href="http://joemphilips.com/post/gpg_memo/" target="_blank" rel="nofollow noopener noreferrer">GPGで自分用の秘密鍵を1つに統一する</a>
を参考に進めていきました。</p>
<p>上記記事ではエアギャップコンピュータが推奨されていますが、今回はマスターキーのバックアップの
利便性のため、ネットワークに接続した状態で行いました。
<a href="https://www.qubes-os.org/" target="_blank" rel="nofollow noopener noreferrer">QUBES OS</a> はよさそうですね。 Fedora ベースなのが
少し気になるといえばそうですが……(ArchLinux に慣れているため)。</p>
<p>さて、普段使いの環境にはマスターキーの秘密鍵は置いておきたくないので、
マスターキーの生成は別の環境で行います。
バックアップの利便性なども考えて、 LUKS で暗号化したパーティションをファイルに保存します。</p>
<pre class="language-shell"><code class="language-shell"><span class="token function">dd</span> <span class="token assign-left variable">if</span><span class="token operator">=</span>/dev/zero <span class="token assign-left variable">of</span><span class="token operator">=</span>encrypted_partition.img <span class="token assign-left variable">bs</span><span class="token operator">=</span>1M <span class="token assign-left variable">count</span><span class="token operator">=</span><span class="token number">64</span>
<span class="token function">sudo</span> cryptsetup luksFormat -i <span class="token number">5000</span> --use-random encrypted_partition.img
<span class="token comment"># type 'YES' and set password</span>
<span class="token function">sudo</span> cryptsetup luksOpen encrypted_partition.img gpg_container
<span class="token function">sudo</span> mkfs.ext4 /dev/mapper/gpg_container
<span class="token function">sudo</span> <span class="token function">mount</span> /dev/mapper/gpg_container /mnt
<span class="token function">sudo</span> <span class="token function">mkdir</span> /mnt/.gnupg
<span class="token function">sudo</span> <span class="token function">chown</span> <span class="token punctuation">[</span>current_user<span class="token punctuation">]</span> /mnt/.gnupg</code></pre>
<p>GPG の操作は今作成した <code>/mnt/.gnupg</code> を GNUPGHOME に設定して行います。
必要なだけマスターキーとサブキーを作成していきます。</p>
<pre class="language-shell"><code class="language-shell"><span class="token assign-left variable">GNUPGHOME</span><span class="token operator">=</span>/mnt/.gnupg gpg --full-gen-key</code></pre>
<p>作成が終わったら、サブキーだけをエクスポートします。キーの fingerprint は <code>gpg -K</code> で確認できます。</p>
<pre class="language-shell"><code class="language-shell"><span class="token assign-left variable">GNUPGHOME</span><span class="token operator">=</span>/mnt/.gnupg gpg --output <span class="token punctuation">[</span>exported-file<span class="token punctuation">]</span> --export-secret-subkeys <span class="token punctuation">[</span>fingerprint<span class="token punctuation">]</span></code></pre>
<p>エクスポートしたファイルを scp などで普段使う環境にコピーしたら、インポートして信頼します。
今自分で作成したキーなので、信頼度は 5 (I trust ultimately) でよいでしょう。</p>
<pre class="language-shell"><code class="language-shell">gpg --import <span class="token punctuation">[</span>exported-file<span class="token punctuation">]</span>
gpg --edit-key <span class="token punctuation">[</span>fingerprint<span class="token punctuation">]</span>
    <span class="token operator">></span> trust
    <span class="token operator">></span> <span class="token number">5</span> <span class="token comment"># I trust ultimately</span>
    <span class="token operator">></span> save</code></pre>
<p>あとは、 <code>gpg -K --with-keygrip</code> で ssh に使いたいキーの keygrip を確認して、 <code>~/.gnupg/sshcontrol</code> に追加します。
<code>~/.ssh/config</code> の <code>IdentityFile</code> でキーを指定する場合は、 <code>gpg -K --with-subkey-fingerprint</code> でサブキーの
fingerprint を確認して、 <code>gpg --export-ssh-key [fingerprint] > ~/.ssh/id_something.pub</code> を実行します。
<code>IdentityFile</code> には今作成した <code>id_something.pub</code> を指定してください。</p>
<p>gpg-agent を ssh-agent として使う方法は
<a href="/2020-01/introduction-of-gpg-ssh-agent/">GnuPGのssh-agentエミュレータを使ってみました</a>
に書いた通りです。</p>
<p>addkey をする場合やサブキーの有効期限を変更する場合などはマスターキーが必要になりますが、
それまではマスターキーの秘密鍵がない状態でうまく機能するでしょう。
将来的にはオフラインのマシン上で行いたいですが、ひとまず普段から GPG を使う習慣をつけて
慣れておこうと思っています。</p>
</p></div><div class="footer"><p>
      Built with
      <a href="//gridsome.org" class="link">Gridsome</a></p></div></div>
    <script>window.__INITIAL_STATE__={"data":{"post":{"id":"e2e3946133d833ff279df664dae4e4d9","title":"新しいGPGキーを作成しました","content":"\u003Cp\u003EYubikey もあることですし、そろそろ GPG や SSH の秘密鍵を統一しようと思います。\n\u003Ca href=\"http:\u002F\u002Fjoemphilips.com\u002Fpost\u002Fgpg_memo\u002F\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003EGPGで自分用の秘密鍵を1つに統一する\u003C\u002Fa\u003E\nを参考に進めていきました。\u003C\u002Fp\u003E\n\u003Cp\u003E上記記事ではエアギャップコンピュータが推奨されていますが、今回はマスターキーのバックアップの\n利便性のため、ネットワークに接続した状態で行いました。\n\u003Ca href=\"https:\u002F\u002Fwww.qubes-os.org\u002F\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003EQUBES OS\u003C\u002Fa\u003E はよさそうですね。 Fedora ベースなのが\n少し気になるといえばそうですが……(ArchLinux に慣れているため)。\u003C\u002Fp\u003E\n\u003Cp\u003Eさて、普段使いの環境にはマスターキーの秘密鍵は置いておきたくないので、\nマスターキーの生成は別の環境で行います。\nバックアップの利便性なども考えて、 LUKS で暗号化したパーティションをファイルに保存します。\u003C\u002Fp\u003E\n\u003Cpre class=\"language-shell\"\u003E\u003Ccode class=\"language-shell\"\u003E\u003Cspan class=\"token function\"\u003Edd\u003C\u002Fspan\u003E \u003Cspan class=\"token assign-left variable\"\u003Eif\u003C\u002Fspan\u003E\u003Cspan class=\"token operator\"\u003E=\u003C\u002Fspan\u003E\u002Fdev\u002Fzero \u003Cspan class=\"token assign-left variable\"\u003Eof\u003C\u002Fspan\u003E\u003Cspan class=\"token operator\"\u003E=\u003C\u002Fspan\u003Eencrypted_partition.img \u003Cspan class=\"token assign-left variable\"\u003Ebs\u003C\u002Fspan\u003E\u003Cspan class=\"token operator\"\u003E=\u003C\u002Fspan\u003E1M \u003Cspan class=\"token assign-left variable\"\u003Ecount\u003C\u002Fspan\u003E\u003Cspan class=\"token operator\"\u003E=\u003C\u002Fspan\u003E\u003Cspan class=\"token number\"\u003E64\u003C\u002Fspan\u003E\n\u003Cspan class=\"token function\"\u003Esudo\u003C\u002Fspan\u003E cryptsetup luksFormat -i \u003Cspan class=\"token number\"\u003E5000\u003C\u002Fspan\u003E --use-random encrypted_partition.img\n\u003Cspan class=\"token comment\"\u003E# type 'YES' and set password\u003C\u002Fspan\u003E\n\u003Cspan class=\"token function\"\u003Esudo\u003C\u002Fspan\u003E cryptsetup luksOpen encrypted_partition.img gpg_container\n\u003Cspan class=\"token function\"\u003Esudo\u003C\u002Fspan\u003E mkfs.ext4 \u002Fdev\u002Fmapper\u002Fgpg_container\n\u003Cspan class=\"token function\"\u003Esudo\u003C\u002Fspan\u003E \u003Cspan class=\"token function\"\u003Emount\u003C\u002Fspan\u003E \u002Fdev\u002Fmapper\u002Fgpg_container \u002Fmnt\n\u003Cspan class=\"token function\"\u003Esudo\u003C\u002Fspan\u003E \u003Cspan class=\"token function\"\u003Emkdir\u003C\u002Fspan\u003E \u002Fmnt\u002F.gnupg\n\u003Cspan class=\"token function\"\u003Esudo\u003C\u002Fspan\u003E \u003Cspan class=\"token function\"\u003Echown\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E[\u003C\u002Fspan\u003Ecurrent_user\u003Cspan class=\"token punctuation\"\u003E]\u003C\u002Fspan\u003E \u002Fmnt\u002F.gnupg\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003EGPG の操作は今作成した \u003Ccode\u003E\u002Fmnt\u002F.gnupg\u003C\u002Fcode\u003E を GNUPGHOME に設定して行います。\n必要なだけマスターキーとサブキーを作成していきます。\u003C\u002Fp\u003E\n\u003Cpre class=\"language-shell\"\u003E\u003Ccode class=\"language-shell\"\u003E\u003Cspan class=\"token assign-left variable\"\u003EGNUPGHOME\u003C\u002Fspan\u003E\u003Cspan class=\"token operator\"\u003E=\u003C\u002Fspan\u003E\u002Fmnt\u002F.gnupg gpg --full-gen-key\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003E作成が終わったら、サブキーだけをエクスポートします。キーの fingerprint は \u003Ccode\u003Egpg -K\u003C\u002Fcode\u003E で確認できます。\u003C\u002Fp\u003E\n\u003Cpre class=\"language-shell\"\u003E\u003Ccode class=\"language-shell\"\u003E\u003Cspan class=\"token assign-left variable\"\u003EGNUPGHOME\u003C\u002Fspan\u003E\u003Cspan class=\"token operator\"\u003E=\u003C\u002Fspan\u003E\u002Fmnt\u002F.gnupg gpg --output \u003Cspan class=\"token punctuation\"\u003E[\u003C\u002Fspan\u003Eexported-file\u003Cspan class=\"token punctuation\"\u003E]\u003C\u002Fspan\u003E --export-secret-subkeys \u003Cspan class=\"token punctuation\"\u003E[\u003C\u002Fspan\u003Efingerprint\u003Cspan class=\"token punctuation\"\u003E]\u003C\u002Fspan\u003E\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003Eエクスポートしたファイルを scp などで普段使う環境にコピーしたら、インポートして信頼します。\n今自分で作成したキーなので、信頼度は 5 (I trust ultimately) でよいでしょう。\u003C\u002Fp\u003E\n\u003Cpre class=\"language-shell\"\u003E\u003Ccode class=\"language-shell\"\u003Egpg --import \u003Cspan class=\"token punctuation\"\u003E[\u003C\u002Fspan\u003Eexported-file\u003Cspan class=\"token punctuation\"\u003E]\u003C\u002Fspan\u003E\ngpg --edit-key \u003Cspan class=\"token punctuation\"\u003E[\u003C\u002Fspan\u003Efingerprint\u003Cspan class=\"token punctuation\"\u003E]\u003C\u002Fspan\u003E\n    \u003Cspan class=\"token operator\"\u003E\u003E\u003C\u002Fspan\u003E trust\n    \u003Cspan class=\"token operator\"\u003E\u003E\u003C\u002Fspan\u003E \u003Cspan class=\"token number\"\u003E5\u003C\u002Fspan\u003E \u003Cspan class=\"token comment\"\u003E# I trust ultimately\u003C\u002Fspan\u003E\n    \u003Cspan class=\"token operator\"\u003E\u003E\u003C\u002Fspan\u003E save\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003Eあとは、 \u003Ccode\u003Egpg -K --with-keygrip\u003C\u002Fcode\u003E で ssh に使いたいキーの keygrip を確認して、 \u003Ccode\u003E~\u002F.gnupg\u002Fsshcontrol\u003C\u002Fcode\u003E に追加します。\n\u003Ccode\u003E~\u002F.ssh\u002Fconfig\u003C\u002Fcode\u003E の \u003Ccode\u003EIdentityFile\u003C\u002Fcode\u003E でキーを指定する場合は、 \u003Ccode\u003Egpg -K --with-subkey-fingerprint\u003C\u002Fcode\u003E でサブキーの\nfingerprint を確認して、 \u003Ccode\u003Egpg --export-ssh-key [fingerprint] \u003E ~\u002F.ssh\u002Fid_something.pub\u003C\u002Fcode\u003E を実行します。\n\u003Ccode\u003EIdentityFile\u003C\u002Fcode\u003E には今作成した \u003Ccode\u003Eid_something.pub\u003C\u002Fcode\u003E を指定してください。\u003C\u002Fp\u003E\n\u003Cp\u003Egpg-agent を ssh-agent として使う方法は\n\u003Ca href=\"\u002F2020-01\u002Fintroduction-of-gpg-ssh-agent\u002F\"\u003EGnuPGのssh-agentエミュレータを使ってみました\u003C\u002Fa\u003E\nに書いた通りです。\u003C\u002Fp\u003E\n\u003Cp\u003Eaddkey をする場合やサブキーの有効期限を変更する場合などはマスターキーが必要になりますが、\nそれまではマスターキーの秘密鍵がない状態でうまく機能するでしょう。\n将来的にはオフラインのマシン上で行いたいですが、ひとまず普段から GPG を使う習慣をつけて\n慣れておこうと思っています。\u003C\u002Fp\u003E\n","date":"04 February 2020","timeToRead":1}},"context":{}};(function(){var s;(s=document.currentScript||document.scripts[document.scripts.length-1]).parentNode.removeChild(s);}());</script><script src="/gridsome-blog/assets/js/app.95c605ed.js" defer></script><script src="/gridsome-blog/assets/js/page--src--templates--post-vue.c275e0ae.js" defer></script>
  </body>
</html>
