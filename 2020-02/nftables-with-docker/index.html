<!DOCTYPE html>
<html data-html-server-rendered="true" lang="en" data-vue-tag="%7B%22lang%22:%7B%22ssr%22:%22en%22%7D%7D">
  <head>
    <title>Gridsome - Gridsome</title><meta name="gridsome:hash" content="76ea6c1f58ad1038a40251c936d650b1c965a92c"><meta data-vue-tag="ssr" charset="utf-8"><meta data-vue-tag="ssr" name="generator" content="Gridsome v0.7.13"><meta data-vue-tag="ssr" data-key="viewport" name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"><meta data-vue-tag="ssr" data-key="format-detection" name="format-detection" content="telephone=no"><link data-vue-tag="ssr" rel="icon" href="data:,"><link data-vue-tag="ssr" rel="icon" type="image/png" sizes="16x16" href="/gridsome-blog/assets/static/favicon.ce0531f.9bb7ffafafc09ac851d81afb65b8ef59.png"><link data-vue-tag="ssr" rel="icon" type="image/png" sizes="32x32" href="/gridsome-blog/assets/static/favicon.ac8d93a.9bb7ffafafc09ac851d81afb65b8ef59.png"><link data-vue-tag="ssr" rel="icon" type="image/png" sizes="96x96" href="/gridsome-blog/assets/static/favicon.b9532cc.9bb7ffafafc09ac851d81afb65b8ef59.png"><link data-vue-tag="ssr" rel="apple-touch-icon" type="image/png" sizes="76x76" href="/gridsome-blog/assets/static/favicon.f22e9f3.9bb7ffafafc09ac851d81afb65b8ef59.png"><link data-vue-tag="ssr" rel="apple-touch-icon" type="image/png" sizes="152x152" href="/gridsome-blog/assets/static/favicon.62d22cb.9bb7ffafafc09ac851d81afb65b8ef59.png"><link data-vue-tag="ssr" rel="apple-touch-icon" type="image/png" sizes="120x120" href="/gridsome-blog/assets/static/favicon.1539b60.9bb7ffafafc09ac851d81afb65b8ef59.png"><link data-vue-tag="ssr" rel="apple-touch-icon" type="image/png" sizes="167x167" href="/gridsome-blog/assets/static/favicon.dc0cdc5.9bb7ffafafc09ac851d81afb65b8ef59.png"><link data-vue-tag="ssr" rel="apple-touch-icon" type="image/png" sizes="180x180" href="/gridsome-blog/assets/static/favicon.7b22250.9bb7ffafafc09ac851d81afb65b8ef59.png"><link rel="preload" href="/gridsome-blog/assets/css/0.styles.dd5de3ed.css" as="style"><link rel="preload" href="/gridsome-blog/assets/js/app.b511346b.js" as="script"><link rel="preload" href="/gridsome-blog/assets/js/page--src--templates--post-vue.4554ab62.js" as="script"><link rel="prefetch" href="/gridsome-blog/assets/js/page--node-modules--gridsome--app--pages--404-vue.d1fb8354.js"><link rel="prefetch" href="/gridsome-blog/assets/js/page--src--pages--index-vue.3f2795c4.js"><link rel="stylesheet" href="/gridsome-blog/assets/css/0.styles.dd5de3ed.css"><noscript data-vue-tag="ssr"><style>.g-image--loading{display:none;}</style></noscript>
  </head>
  <body >
    <div data-server-rendered="true" id="app" class="layout"><header class="header"><strong><a href="/gridsome-blog/" class="active">Gridsome</a></strong><nav class="nav"><a href="/gridsome-blog/" class="nav__link active">Home</a></nav></header><div class="post-title"><h1>nftablesでdockerを使ってみました</h1><p class="post-date"> 22 February 2020 | 2 min read</p></div><div class="post-content"><p><p>Linux 3.13 から利用可能な、 iptables を置き換える(ことを目的とした)パケット分類フレームワークの(ファイアーウォール？)
nftables を、 docker を使っている環境で使ってみました。</p>
<h2 id="インストール・有効化"><a href="#%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB%E3%83%BB%E6%9C%89%E5%8A%B9%E5%8C%96" aria-hidden="true"><span class="icon icon-link"></span></a>インストール・有効化</h2>
<p>Docker から使うには、 iptables の互換フロントエンドをインストールする必要があります。
nftables と一緒にインストールするには、以下を実行します。
(<code>iptables-nft</code> は <code>iptables</code> を置き換えます。)</p>
<pre class="language-shell"><code class="language-shell"><span class="token function">sudo</span> pacman -S nftables iptables-nft</code></pre>
<p><code>nftables.service</code> を起動すると、 <code>/etc/nftables.conf</code> から設定を読み込みます。
起動・自動的に起動するようにするには、以下を実行します。</p>
<pre class="language-shell"><code class="language-shell"><span class="token function">sudo</span> systemctl enbale --now nftables</code></pre>
<p>ArchLinux の nftables パッケージの <code>etc/nftables.conf</code> には、
シンプルでセキュアなファイアーウォールが設定されています。
1:0.9.3-1 時点での設定内容は以下の通りです。</p>
<pre class="language-text"><code class="language-text">#!/usr/bin/nft -f
# ipv4/ipv6 Simple & Safe Firewall
# you can find examples in /usr/share/nftables/

table inet filter {
  chain input {
    type filter hook input priority 0;

    # allow established/related connections
    ct state {established, related} accept

    # early drop of invalid connections
    ct state invalid drop

    # allow from loopback
    iifname lo accept

    # allow icmp
    ip protocol icmp accept
    ip6 nexthdr icmpv6 accept

    # allow ssh
    tcp dport ssh accept

    # everything else
    reject with icmpx type port-unreachable
  }
  chain forward {
    type filter hook forward priority 0;
    drop
  }
  chain output {
    type filter hook output priority 0;
  }

}

# vim:set ts=2 sw=2 et:</code></pre>
<h2 id="docker-を使用するための設定"><a href="#docker-%E3%82%92%E4%BD%BF%E7%94%A8%E3%81%99%E3%82%8B%E3%81%9F%E3%82%81%E3%81%AE%E8%A8%AD%E5%AE%9A" aria-hidden="true"><span class="icon icon-link"></span></a>Docker を使用するための設定</h2>
<p>標準のままだと、 Docker コンテナとの通信は forward チェインのルールにより drop されてしまいます。
docker エンジンによって作成される <code>DOCKER-USER</code> チェインのパケットを accept するには、以下のコマンドを実行します。</p>
<pre class="language-shell"><code class="language-shell"><span class="token comment"># ip ファミリーに filter テーブルを作成し、 DOCKER-USER チェインを追加する</span>
$ <span class="token function">sudo</span> nft <span class="token function">add</span> table <span class="token function">ip</span> filter                                                                                                                                                                          :<span class="token punctuation">(</span>
$ <span class="token function">sudo</span> nft <span class="token function">add</span> chain <span class="token function">ip</span> filter DOCKER-<span class="token environment constant">USER</span>
$ <span class="token function">sudo</span> nft <span class="token function">add</span> rule <span class="token function">ip</span> filter DOCKER-<span class="token environment constant">USER</span> mark <span class="token builtin class-name">set</span> <span class="token number">1</span>
<span class="token comment"># inet filter forward の drop ルールの handle を確認する (この場合は `handle 12`)</span>
$ <span class="token function">sudo</span> nft list ruleset -a
table inet filter <span class="token punctuation">{</span> <span class="token comment"># handle 25</span>
	chain input <span class="token punctuation">{</span> <span class="token comment"># handle 1</span>
		<span class="token builtin class-name">type</span> filter hook input priority filter<span class="token punctuation">;</span> policy accept<span class="token punctuation">;</span>
		ct state <span class="token punctuation">{</span> established, related <span class="token punctuation">}</span> accept <span class="token comment"># handle 5</span>
		ct state invalid drop <span class="token comment"># handle 6</span>
		iifname <span class="token string">"lo"</span> accept <span class="token comment"># handle 7</span>
		<span class="token function">ip</span> protocol icmp accept <span class="token comment"># handle 8</span>
		ip6 nexthdr ipv6-icmp accept <span class="token comment"># handle 9</span>
		tcp dport <span class="token number">22</span> accept <span class="token comment"># handle 10</span>
		reject <span class="token comment"># handle 11</span>
	<span class="token punctuation">}</span>

	chain forward <span class="token punctuation">{</span> <span class="token comment"># handle 2</span>
		<span class="token builtin class-name">type</span> filter hook forward priority filter<span class="token punctuation">;</span> policy accept<span class="token punctuation">;</span>
		drop <span class="token comment"># handle 12</span>
	<span class="token punctuation">}</span>

	chain output <span class="token punctuation">{</span> <span class="token comment"># handle 3</span>
		<span class="token builtin class-name">type</span> filter hook output priority filter<span class="token punctuation">;</span> policy accept<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
table <span class="token function">ip</span> filter <span class="token punctuation">{</span> <span class="token comment"># handle 26</span>
	chain DOCKER-<span class="token environment constant">USER</span> <span class="token punctuation">{</span> <span class="token comment"># handle 1</span>
		meta mark <span class="token builtin class-name">set</span> 0x00000001 <span class="token comment"># handle 2</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment"># drop ルールの前に insert する(ここの `handle 12` は上で確認した handle に変更してください)</span>
$ <span class="token function">sudo</span> nft insert rule inet filter forward handle <span class="token number">12</span> mark <span class="token number">1</span> accept
<span class="token comment"># ルールを /etc/nftables.conf に保存する</span>
$ <span class="token function">sudo</span> nft list ruleset <span class="token operator">|</span> <span class="token function">sudo</span> <span class="token function">tee</span> /etc/nftables.conf 
table inet filter <span class="token punctuation">{</span>
	chain input <span class="token punctuation">{</span>
		<span class="token builtin class-name">type</span> filter hook input priority filter<span class="token punctuation">;</span> policy accept<span class="token punctuation">;</span>
		ct state <span class="token punctuation">{</span> established, related <span class="token punctuation">}</span> accept
		ct state invalid drop
		iifname <span class="token string">"lo"</span> accept
		<span class="token function">ip</span> protocol icmp accept
		ip6 nexthdr ipv6-icmp accept
		tcp dport <span class="token number">22</span> accept
		reject
	<span class="token punctuation">}</span>

	chain forward <span class="token punctuation">{</span>
		<span class="token builtin class-name">type</span> filter hook forward priority filter<span class="token punctuation">;</span> policy accept<span class="token punctuation">;</span>
		meta mark 0x00000001 accept
		drop
	<span class="token punctuation">}</span>

	chain output <span class="token punctuation">{</span>
		<span class="token builtin class-name">type</span> filter hook output priority filter<span class="token punctuation">;</span> policy accept<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
table <span class="token function">ip</span> filter <span class="token punctuation">{</span>
	chain DOCKER-<span class="token environment constant">USER</span> <span class="token punctuation">{</span>
		meta mark <span class="token builtin class-name">set</span> 0x00000001
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>nftables の設定の保存が完了したら、 <code>docker.service</code> を再起動することで
docker によりファイアウォールルールが作成されます。
(docker は iptables フロントエンドを使用するため、 <code>iptables-nft</code> パッケージに付属する <code>iptables</code> コマンドを使用して
ルールが追加されます。)
念のため <code>nftables.service</code> も再起動して、今保存したルールを再読み込みします。</p>
<p><code>sudo systemctl restart nftables docker</code></p>
<p><code>docker.service</code> が正常に起動したら、 docker のルールが追加され、コンテナとの通信ができるようになっているはずです。</p>
<h2 id="nftables-インストール前の-iptables-ルールの参照"><a href="#nftables-%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB%E5%89%8D%E3%81%AE-iptables-%E3%83%AB%E3%83%BC%E3%83%AB%E3%81%AE%E5%8F%82%E7%85%A7" aria-hidden="true"><span class="icon icon-link"></span></a>nftables インストール前の iptables ルールの参照</h2>
<p><code>iptables</code> コマンドの代わりに <code>iptables-legacy</code> コマンドを使用することで、
iptables で使っていたルールを確認することができます。</p>
<p>docker のルールもこちらからインポートしようかなと思ったのですが、そうすると iptables-nft の互換性が壊れてしまって
docker.service の起動に失敗したので、 ArchWiki の方法に従いました。</p>
</p></div><div class="footer"><p>
      Built with
      <a href="//gridsome.org" class="link">Gridsome</a></p></div></div>
    <script>window.__INITIAL_STATE__={"data":{"post":{"id":"a05ef1af80a9687c625a05028ce0a52c","title":"nftablesでdockerを使ってみました","content":"\u003Cp\u003ELinux 3.13 から利用可能な、 iptables を置き換える(ことを目的とした)パケット分類フレームワークの(ファイアーウォール？)\nnftables を、 docker を使っている環境で使ってみました。\u003C\u002Fp\u003E\n\u003Ch2 id=\"インストール・有効化\"\u003E\u003Ca href=\"#%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB%E3%83%BB%E6%9C%89%E5%8A%B9%E5%8C%96\" aria-hidden=\"true\"\u003E\u003Cspan class=\"icon icon-link\"\u003E\u003C\u002Fspan\u003E\u003C\u002Fa\u003Eインストール・有効化\u003C\u002Fh2\u003E\n\u003Cp\u003EDocker から使うには、 iptables の互換フロントエンドをインストールする必要があります。\nnftables と一緒にインストールするには、以下を実行します。\n(\u003Ccode\u003Eiptables-nft\u003C\u002Fcode\u003E は \u003Ccode\u003Eiptables\u003C\u002Fcode\u003E を置き換えます。)\u003C\u002Fp\u003E\n\u003Cpre class=\"language-shell\"\u003E\u003Ccode class=\"language-shell\"\u003E\u003Cspan class=\"token function\"\u003Esudo\u003C\u002Fspan\u003E pacman -S nftables iptables-nft\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003E\u003Ccode\u003Enftables.service\u003C\u002Fcode\u003E を起動すると、 \u003Ccode\u003E\u002Fetc\u002Fnftables.conf\u003C\u002Fcode\u003E から設定を読み込みます。\n起動・自動的に起動するようにするには、以下を実行します。\u003C\u002Fp\u003E\n\u003Cpre class=\"language-shell\"\u003E\u003Ccode class=\"language-shell\"\u003E\u003Cspan class=\"token function\"\u003Esudo\u003C\u002Fspan\u003E systemctl enbale --now nftables\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003EArchLinux の nftables パッケージの \u003Ccode\u003Eetc\u002Fnftables.conf\u003C\u002Fcode\u003E には、\nシンプルでセキュアなファイアーウォールが設定されています。\n1:0.9.3-1 時点での設定内容は以下の通りです。\u003C\u002Fp\u003E\n\u003Cpre class=\"language-text\"\u003E\u003Ccode class=\"language-text\"\u003E#!\u002Fusr\u002Fbin\u002Fnft -f\n# ipv4\u002Fipv6 Simple & Safe Firewall\n# you can find examples in \u002Fusr\u002Fshare\u002Fnftables\u002F\n\ntable inet filter {\n  chain input {\n    type filter hook input priority 0;\n\n    # allow established\u002Frelated connections\n    ct state {established, related} accept\n\n    # early drop of invalid connections\n    ct state invalid drop\n\n    # allow from loopback\n    iifname lo accept\n\n    # allow icmp\n    ip protocol icmp accept\n    ip6 nexthdr icmpv6 accept\n\n    # allow ssh\n    tcp dport ssh accept\n\n    # everything else\n    reject with icmpx type port-unreachable\n  }\n  chain forward {\n    type filter hook forward priority 0;\n    drop\n  }\n  chain output {\n    type filter hook output priority 0;\n  }\n\n}\n\n# vim:set ts=2 sw=2 et:\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Ch2 id=\"docker-を使用するための設定\"\u003E\u003Ca href=\"#docker-%E3%82%92%E4%BD%BF%E7%94%A8%E3%81%99%E3%82%8B%E3%81%9F%E3%82%81%E3%81%AE%E8%A8%AD%E5%AE%9A\" aria-hidden=\"true\"\u003E\u003Cspan class=\"icon icon-link\"\u003E\u003C\u002Fspan\u003E\u003C\u002Fa\u003EDocker を使用するための設定\u003C\u002Fh2\u003E\n\u003Cp\u003E標準のままだと、 Docker コンテナとの通信は forward チェインのルールにより drop されてしまいます。\ndocker エンジンによって作成される \u003Ccode\u003EDOCKER-USER\u003C\u002Fcode\u003E チェインのパケットを accept するには、以下のコマンドを実行します。\u003C\u002Fp\u003E\n\u003Cpre class=\"language-shell\"\u003E\u003Ccode class=\"language-shell\"\u003E\u003Cspan class=\"token comment\"\u003E# ip ファミリーに filter テーブルを作成し、 DOCKER-USER チェインを追加する\u003C\u002Fspan\u003E\n$ \u003Cspan class=\"token function\"\u003Esudo\u003C\u002Fspan\u003E nft \u003Cspan class=\"token function\"\u003Eadd\u003C\u002Fspan\u003E table \u003Cspan class=\"token function\"\u003Eip\u003C\u002Fspan\u003E filter                                                                                                                                                                          :\u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003E\n$ \u003Cspan class=\"token function\"\u003Esudo\u003C\u002Fspan\u003E nft \u003Cspan class=\"token function\"\u003Eadd\u003C\u002Fspan\u003E chain \u003Cspan class=\"token function\"\u003Eip\u003C\u002Fspan\u003E filter DOCKER-\u003Cspan class=\"token environment constant\"\u003EUSER\u003C\u002Fspan\u003E\n$ \u003Cspan class=\"token function\"\u003Esudo\u003C\u002Fspan\u003E nft \u003Cspan class=\"token function\"\u003Eadd\u003C\u002Fspan\u003E rule \u003Cspan class=\"token function\"\u003Eip\u003C\u002Fspan\u003E filter DOCKER-\u003Cspan class=\"token environment constant\"\u003EUSER\u003C\u002Fspan\u003E mark \u003Cspan class=\"token builtin class-name\"\u003Eset\u003C\u002Fspan\u003E \u003Cspan class=\"token number\"\u003E1\u003C\u002Fspan\u003E\n\u003Cspan class=\"token comment\"\u003E# inet filter forward の drop ルールの handle を確認する (この場合は `handle 12`)\u003C\u002Fspan\u003E\n$ \u003Cspan class=\"token function\"\u003Esudo\u003C\u002Fspan\u003E nft list ruleset -a\ntable inet filter \u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003E \u003Cspan class=\"token comment\"\u003E# handle 25\u003C\u002Fspan\u003E\n\tchain input \u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003E \u003Cspan class=\"token comment\"\u003E# handle 1\u003C\u002Fspan\u003E\n\t\t\u003Cspan class=\"token builtin class-name\"\u003Etype\u003C\u002Fspan\u003E filter hook input priority filter\u003Cspan class=\"token punctuation\"\u003E;\u003C\u002Fspan\u003E policy accept\u003Cspan class=\"token punctuation\"\u003E;\u003C\u002Fspan\u003E\n\t\tct state \u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003E established, related \u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E accept \u003Cspan class=\"token comment\"\u003E# handle 5\u003C\u002Fspan\u003E\n\t\tct state invalid drop \u003Cspan class=\"token comment\"\u003E# handle 6\u003C\u002Fspan\u003E\n\t\tiifname \u003Cspan class=\"token string\"\u003E\"lo\"\u003C\u002Fspan\u003E accept \u003Cspan class=\"token comment\"\u003E# handle 7\u003C\u002Fspan\u003E\n\t\t\u003Cspan class=\"token function\"\u003Eip\u003C\u002Fspan\u003E protocol icmp accept \u003Cspan class=\"token comment\"\u003E# handle 8\u003C\u002Fspan\u003E\n\t\tip6 nexthdr ipv6-icmp accept \u003Cspan class=\"token comment\"\u003E# handle 9\u003C\u002Fspan\u003E\n\t\ttcp dport \u003Cspan class=\"token number\"\u003E22\u003C\u002Fspan\u003E accept \u003Cspan class=\"token comment\"\u003E# handle 10\u003C\u002Fspan\u003E\n\t\treject \u003Cspan class=\"token comment\"\u003E# handle 11\u003C\u002Fspan\u003E\n\t\u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E\n\n\tchain forward \u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003E \u003Cspan class=\"token comment\"\u003E# handle 2\u003C\u002Fspan\u003E\n\t\t\u003Cspan class=\"token builtin class-name\"\u003Etype\u003C\u002Fspan\u003E filter hook forward priority filter\u003Cspan class=\"token punctuation\"\u003E;\u003C\u002Fspan\u003E policy accept\u003Cspan class=\"token punctuation\"\u003E;\u003C\u002Fspan\u003E\n\t\tdrop \u003Cspan class=\"token comment\"\u003E# handle 12\u003C\u002Fspan\u003E\n\t\u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E\n\n\tchain output \u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003E \u003Cspan class=\"token comment\"\u003E# handle 3\u003C\u002Fspan\u003E\n\t\t\u003Cspan class=\"token builtin class-name\"\u003Etype\u003C\u002Fspan\u003E filter hook output priority filter\u003Cspan class=\"token punctuation\"\u003E;\u003C\u002Fspan\u003E policy accept\u003Cspan class=\"token punctuation\"\u003E;\u003C\u002Fspan\u003E\n\t\u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E\n\u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E\ntable \u003Cspan class=\"token function\"\u003Eip\u003C\u002Fspan\u003E filter \u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003E \u003Cspan class=\"token comment\"\u003E# handle 26\u003C\u002Fspan\u003E\n\tchain DOCKER-\u003Cspan class=\"token environment constant\"\u003EUSER\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003E \u003Cspan class=\"token comment\"\u003E# handle 1\u003C\u002Fspan\u003E\n\t\tmeta mark \u003Cspan class=\"token builtin class-name\"\u003Eset\u003C\u002Fspan\u003E 0x00000001 \u003Cspan class=\"token comment\"\u003E# handle 2\u003C\u002Fspan\u003E\n\t\u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E\n\u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E\n\u003Cspan class=\"token comment\"\u003E# drop ルールの前に insert する(ここの `handle 12` は上で確認した handle に変更してください)\u003C\u002Fspan\u003E\n$ \u003Cspan class=\"token function\"\u003Esudo\u003C\u002Fspan\u003E nft insert rule inet filter forward handle \u003Cspan class=\"token number\"\u003E12\u003C\u002Fspan\u003E mark \u003Cspan class=\"token number\"\u003E1\u003C\u002Fspan\u003E accept\n\u003Cspan class=\"token comment\"\u003E# ルールを \u002Fetc\u002Fnftables.conf に保存する\u003C\u002Fspan\u003E\n$ \u003Cspan class=\"token function\"\u003Esudo\u003C\u002Fspan\u003E nft list ruleset \u003Cspan class=\"token operator\"\u003E|\u003C\u002Fspan\u003E \u003Cspan class=\"token function\"\u003Esudo\u003C\u002Fspan\u003E \u003Cspan class=\"token function\"\u003Etee\u003C\u002Fspan\u003E \u002Fetc\u002Fnftables.conf \ntable inet filter \u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003E\n\tchain input \u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003E\n\t\t\u003Cspan class=\"token builtin class-name\"\u003Etype\u003C\u002Fspan\u003E filter hook input priority filter\u003Cspan class=\"token punctuation\"\u003E;\u003C\u002Fspan\u003E policy accept\u003Cspan class=\"token punctuation\"\u003E;\u003C\u002Fspan\u003E\n\t\tct state \u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003E established, related \u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E accept\n\t\tct state invalid drop\n\t\tiifname \u003Cspan class=\"token string\"\u003E\"lo\"\u003C\u002Fspan\u003E accept\n\t\t\u003Cspan class=\"token function\"\u003Eip\u003C\u002Fspan\u003E protocol icmp accept\n\t\tip6 nexthdr ipv6-icmp accept\n\t\ttcp dport \u003Cspan class=\"token number\"\u003E22\u003C\u002Fspan\u003E accept\n\t\treject\n\t\u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E\n\n\tchain forward \u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003E\n\t\t\u003Cspan class=\"token builtin class-name\"\u003Etype\u003C\u002Fspan\u003E filter hook forward priority filter\u003Cspan class=\"token punctuation\"\u003E;\u003C\u002Fspan\u003E policy accept\u003Cspan class=\"token punctuation\"\u003E;\u003C\u002Fspan\u003E\n\t\tmeta mark 0x00000001 accept\n\t\tdrop\n\t\u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E\n\n\tchain output \u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003E\n\t\t\u003Cspan class=\"token builtin class-name\"\u003Etype\u003C\u002Fspan\u003E filter hook output priority filter\u003Cspan class=\"token punctuation\"\u003E;\u003C\u002Fspan\u003E policy accept\u003Cspan class=\"token punctuation\"\u003E;\u003C\u002Fspan\u003E\n\t\u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E\n\u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E\ntable \u003Cspan class=\"token function\"\u003Eip\u003C\u002Fspan\u003E filter \u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003E\n\tchain DOCKER-\u003Cspan class=\"token environment constant\"\u003EUSER\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003E\n\t\tmeta mark \u003Cspan class=\"token builtin class-name\"\u003Eset\u003C\u002Fspan\u003E 0x00000001\n\t\u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E\n\u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003Enftables の設定の保存が完了したら、 \u003Ccode\u003Edocker.service\u003C\u002Fcode\u003E を再起動することで\ndocker によりファイアウォールルールが作成されます。\n(docker は iptables フロントエンドを使用するため、 \u003Ccode\u003Eiptables-nft\u003C\u002Fcode\u003E パッケージに付属する \u003Ccode\u003Eiptables\u003C\u002Fcode\u003E コマンドを使用して\nルールが追加されます。)\n念のため \u003Ccode\u003Enftables.service\u003C\u002Fcode\u003E も再起動して、今保存したルールを再読み込みします。\u003C\u002Fp\u003E\n\u003Cp\u003E\u003Ccode\u003Esudo systemctl restart nftables docker\u003C\u002Fcode\u003E\u003C\u002Fp\u003E\n\u003Cp\u003E\u003Ccode\u003Edocker.service\u003C\u002Fcode\u003E が正常に起動したら、 docker のルールが追加され、コンテナとの通信ができるようになっているはずです。\u003C\u002Fp\u003E\n\u003Ch2 id=\"nftables-インストール前の-iptables-ルールの参照\"\u003E\u003Ca href=\"#nftables-%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB%E5%89%8D%E3%81%AE-iptables-%E3%83%AB%E3%83%BC%E3%83%AB%E3%81%AE%E5%8F%82%E7%85%A7\" aria-hidden=\"true\"\u003E\u003Cspan class=\"icon icon-link\"\u003E\u003C\u002Fspan\u003E\u003C\u002Fa\u003Enftables インストール前の iptables ルールの参照\u003C\u002Fh2\u003E\n\u003Cp\u003E\u003Ccode\u003Eiptables\u003C\u002Fcode\u003E コマンドの代わりに \u003Ccode\u003Eiptables-legacy\u003C\u002Fcode\u003E コマンドを使用することで、\niptables で使っていたルールを確認することができます。\u003C\u002Fp\u003E\n\u003Cp\u003Edocker のルールもこちらからインポートしようかなと思ったのですが、そうすると iptables-nft の互換性が壊れてしまって\ndocker.service の起動に失敗したので、 ArchWiki の方法に従いました。\u003C\u002Fp\u003E\n","date":"22 February 2020","timeToRead":2}},"context":{}};(function(){var s;(s=document.currentScript||document.scripts[document.scripts.length-1]).parentNode.removeChild(s);}());</script><script src="/gridsome-blog/assets/js/app.b511346b.js" defer></script><script src="/gridsome-blog/assets/js/page--src--templates--post-vue.4554ab62.js" defer></script>
  </body>
</html>
